import{u as M,r,s as p,j as e,i as A,d as z,C as O,S as $,L as E,D as R,k as H,l as I}from"./index-R4TGlwoz.js";const U=()=>{var v;const{addNotification:o}=M(),[g,P]=r.useState([]),[C,w]=r.useState(!0),[d,y]=r.useState("pending"),[h,D]=r.useState(""),[_,x]=r.useState(!1),[n,j]=r.useState(null),[S,f]=r.useState(!1),m=r.useCallback(async()=>{w(!0);try{const{data:t,error:s}=await p.from("circulation").select("*, books(title), members(name, phone, register_number)").order("due_date",{ascending:!1});if(s)throw s;P(t||[])}catch(t){console.error("Error fetching fines:",t),o("Failed to load fines data.","error")}finally{w(!1)}},[o]);r.useEffect(()=>{m();const t=p.channel("public:circulation:fines").on("postgres_changes",{event:"*",schema:"public",table:"circulation"},m).subscribe();return()=>{p.removeChannel(t)}},[m]);const b=t=>{const s=new Date,a=new Date(t);if(s.setHours(0,0,0,0),a.setHours(0,0,0,0),s>a){const i=Math.abs(s.getTime()-a.getTime());return Math.ceil(i/(1e3*60*60*24))*1}return 0},N=g.filter(t=>{const s=new Date(t.due_date)<new Date,a=b(t.due_date),i=t.status==="issued"&&s&&a>0||t.status==="returned"&&t.fine_amount>0&&t.fine_status==="unpaid",l=t.fine_status==="paid";return d==="pending"?i:l}).filter(t=>{var a,i,l,c,u,k;if(!h)return!0;const s=h.toLowerCase();return((i=(a=t.members)==null?void 0:a.name)==null?void 0:i.toLowerCase().includes(s))||((c=(l=t.members)==null?void 0:l.register_number)==null?void 0:c.toLowerCase().includes(s))||((k=(u=t.books)==null?void 0:u.title)==null?void 0:k.toLowerCase().includes(s))}),T=g.filter(t=>t.status==="issued"&&new Date(t.due_date)<new Date||t.status==="returned"&&t.fine_amount>0&&t.fine_status==="unpaid").reduce((t,s)=>s.status==="issued"?t+b(s.due_date):t+(s.fine_amount||0),0),F=async()=>{if(n){f(!0);try{if(n.status==="issued"){o("Please return the book before paying the fine.","error"),f(!1),x(!1);return}const{error:t}=await p.from("circulation").update({fine_status:"paid"}).eq("id",n.id);if(t)throw t;o("Fine marked as paid.","success"),m()}catch(t){o(`Error paying fine: ${t.message}`,"error")}finally{f(!1),x(!1),j(null)}}},L=()=>{var a;const t=(a=document.getElementById("fine-print-area"))==null?void 0:a.innerHTML;if(!t)return;const s=window.open("","","height=800,width=1000");s&&(s.document.write("<html><head><title>Penalty Report</title>"),s.document.write("<style>body{font-family:sans-serif;padding:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background-color:#f2f2f2;}h1{text-align:center;}</style>"),s.document.write("</head><body>"),s.document.write(`<h1>Penalty Report - ${d==="pending"?"Pending":"Paid"}</h1>`),s.document.write(t),s.document.write("</body></html>"),s.document.close(),s.print())};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(A,{isOpen:_,title:"Confirm Payment",message:`Are you sure you want to mark the fine of ₹${n==null?void 0:n.fine_amount} for "${(v=n==null?void 0:n.books)==null?void 0:v.title}" as PAID?`,onConfirm:F,onCancel:()=>x(!1),isConfirming:S,confirmText:"Mark as Paid"}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-neutral-800",children:"Penalty Management"}),e.jsx("p",{className:"text-neutral-500 text-sm",children:"Track overdue books and collected penalties."})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("button",{onClick:L,className:"bg-white border border-neutral-300 text-neutral-700 hover:bg-neutral-50 px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm",children:[e.jsx(z,{size:20})," Print"]}),e.jsxs("div",{className:"bg-red-50 border border-red-100 px-4 py-2 rounded-lg flex items-center gap-3",children:[e.jsx("div",{className:"bg-red-100 p-2 rounded-full text-red-600",children:e.jsx(O,{size:20})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-red-600 font-semibold uppercase",children:"Total Pending"}),e.jsxs("p",{className:"text-xl font-bold text-red-700",children:["₹",T.toFixed(2)]})]})]})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-neutral-200",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center mb-6 gap-4",children:[e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-lg w-full md:w-auto",children:[e.jsx("button",{onClick:()=>y("pending"),className:`px-6 py-2 rounded-md text-sm font-medium transition-all ${d==="pending"?"bg-white text-red-600 shadow-sm":"text-neutral-500 hover:text-neutral-700"}`,children:"Pending Penalties"}),e.jsx("button",{onClick:()=>y("paid"),className:`px-6 py-2 rounded-md text-sm font-medium transition-all ${d==="paid"?"bg-white text-green-600 shadow-sm":"text-neutral-500 hover:text-neutral-700"}`,children:"Paid History"})]}),e.jsxs("div",{className:"relative w-full md:w-1/3",children:[e.jsx($,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400",size:20}),e.jsx("input",{type:"text",placeholder:"Search member or book...",value:h,onChange:t=>D(t.target.value),className:"w-full pl-10 pr-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary"})]})]}),e.jsx("div",{className:"overflow-x-auto",id:"fine-print-area",children:C?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx(E,{className:"animate-spin text-primary",size:32})}):N.length===0?e.jsxs("div",{className:"text-center py-16 bg-neutral-50 rounded-lg border border-dashed border-neutral-200",children:[e.jsx(R,{size:48,className:"mx-auto text-neutral-300 mb-3"}),e.jsx("p",{className:"text-lg font-medium text-neutral-600",children:"No records found"}),e.jsx("p",{className:"text-neutral-400 text-sm",children:d==="pending"?"Great! No pending penalties.":"No payment history available."})]}):e.jsxs("table",{className:"min-w-full divide-y divide-neutral-200",children:[e.jsx("thead",{className:"bg-neutral-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-neutral-500 uppercase tracking-wider",children:"Member Details"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-neutral-500 uppercase tracking-wider",children:"Book Title"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-neutral-500 uppercase tracking-wider",children:"Due Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-neutral-500 uppercase tracking-wider",children:d==="pending"?"Days Overdue":"Returned On"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-neutral-500 uppercase tracking-wider",children:"Fine Amount"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-neutral-500 uppercase tracking-wider no-print",children:"Action"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-neutral-200",children:N.map(t=>{var l,c,u;const s=b(t.due_date),a=t.status==="returned"?t.fine_amount:s,i=Math.ceil(Math.abs(new Date().getTime()-new Date(t.due_date).getTime())/(1e3*60*60*24));return e.jsxs("tr",{className:"hover:bg-neutral-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold text-neutral-900",children:((l=t.members)==null?void 0:l.name)||"Unknown"}),e.jsx("span",{className:"text-xs text-neutral-500",children:(c=t.members)==null?void 0:c.register_number})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-neutral-600",children:((u=t.books)==null?void 0:u.title)||"Unknown Book"}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-neutral-600 flex items-center gap-2",children:[e.jsx(H,{size:14,className:"text-neutral-400"}),new Date(t.due_date).toLocaleDateString()]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600",children:t.status==="issued"?`${i} Days (Issued)`:t.return_date?new Date(t.return_date).toLocaleDateString():"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:"text-lg font-bold text-neutral-800",children:["₹",a.toFixed(2)]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap no-print",children:d==="pending"?t.status==="returned"?e.jsx("button",{onClick:()=>{j(t),x(!0)},className:"px-4 py-1.5 bg-green-600 text-white text-xs font-bold rounded-md hover:bg-green-700 shadow-sm transition-colors",children:"Pay Now"}):e.jsx("span",{className:"text-xs text-neutral-400 italic",children:"Return book first"}):e.jsxs("span",{className:"flex items-center gap-1 text-green-600 font-semibold text-sm",children:[e.jsx(I,{size:16})," Paid"]})})]},t.id)})})]})})]})]})};export{U as default};
